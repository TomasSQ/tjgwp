<engine>
	<dot>
		<div class="books-list padding clearfix">
		{{var indexs = '';}}
		<![CDATA[
		{{? it.books && it.books.length}}
		]]>
		{{~it.books :book:i}}
			{{indexs += i + ' ';}}
			<![CDATA[
			{{? i != 0 && i % 4 == 0}}
			]]>
			<div class="chapter-list {{=indexs}}"></div>
			{{?}}
			<div class="book float-left margin-right {{? i >= 4}}margin-top{{?}}" data-book-id="{{=book.id}}">
				<div class="book-cape">
				{{? book.capeImageUrl}}
					<img class="book-cape-url" src="" title="{{=book.title}}"></img>
				{{??}}
					<div class="title" data-no-animation="true">{{=book.title}}</div>
				{{?}}
					<div class="buttons clearfix">
						<input type="file" name="bookCape" data-url="{{=book.uploadUrl}}" data-message="{{=i18n('cape')}}"/>
						<span class="btn edit">{{=i18n('edit')}}</span>
						<span class="btn {{=book.publishDate ? 'unpublish' : 'publish'}}">{{=i18n(book.publishDate ? 'unpublish' : 'publish')}}</span>
					</div>
				</div>
				{{? book.capeImageUrl}}
				<div class="book-title">{{=book.title}}</div>
				{{?}}
				<div class="book-details padding">
					{{=utils.text({text : book.chaptersCount, suffix : 'chapter', noValue : 'no-chapters', plural : true, i18n : true})}}
				</div>
			</div>
			{{? i + 1 == it.books.length}}
			<div class="chapter-list {{=indexs}}"></div>
			{{?}}
		{{~}}
		{{?}}
			<div class="book new float-left margin-right">
				<div class="book-cape">
					<div class="title" data-no-animation="true">
						{{=i18n('new-book')}}
					</div>
				</div>
			</div>
		</div>
	</dot>
	<script>
		if (context.books && context.books.length > 0)
			for (var i = 0; context.books.length > i; i++)
				container.find('[data-book-id="' + context.books[i].id + '"] img').attr('src', context.books[i].capeImageUrl);

		container
			.find('.book .book-cape .title').fitText().end()
			.find('.book.new').click(function() {
				location.hash = 'write/new-book';
			}).end()
			.find('.book .edit').click(function() {
				container.find('.chapter-list').remove();
				var index = $(this).closest('.book').data('index');
				$.getJSON('s/book/' + $(this).closest('.book').data('book-id'), function(book) {
					$.load('.chapter-list.' + index, {book : book}, {componentName : 'chapterList', componentPath : 'book'});
				});
			});

		utils.breadcrumb('books', true);
	</script>
</engine>